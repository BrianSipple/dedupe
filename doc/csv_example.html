<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>csv_example.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>csv_example.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>The following code demonstrates how to use dedupe with a flat (CSV) file. All operations are performed in memory, so it won't work for data sets that are larger than ~10,000 rows. </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">AsciiDammit</span> <span class="kn">import</span> <span class="n">asciiDammit</span>
<span class="kn">import</span> <span class="nn">dedupe</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>We start with a csv file with our messy data. In this example, it is listings of early childhood education centers in Chicago compiled from several different sources. The output file will also be a csv, but with our clustered results.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&#39;./examples/csv_example/&#39;</span><span class="p">)</span>
<span class="n">input_file</span> <span class="o">=</span> <span class="s">&#39;csv_example_messy_input.csv&#39;</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="s">&#39;csv_example_output.csv&#39;</span>
<span class="n">settings_file</span> <span class="o">=</span> <span class="s">&#39;csv_example_learned_settings.json&#39;</span>
<span class="n">training_file</span> <span class="o">=</span> <span class="s">&#39;csv_example_training.json&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Our goal here is to find meaningful duplicates, so things like casing, extra spaces, quotes and new lines can be ignored. preProcess removes these.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">preProcess</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="n">column</span> <span class="o">=</span> <span class="n">asciiDammit</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
  <span class="n">column</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;  +&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
  <span class="n">column</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
  <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">column</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>We read in the data from a CSV file and as we do, we preProcess it. The output is a dictionary of records, where the key is a unique record ID (created with enumerate()) and each value is a frozendict (basically a hashable dictionary) of the row fields.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">readData</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="n">data_d</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span> <span class="p">:</span>
      <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">preProcess</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
      <span class="n">data_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frozendict</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>
      
  <span class="k">return</span><span class="p">(</span><span class="n">data_d</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;importing data ...&#39;</span>
<span class="p">(</span><span class="n">data_d</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span> <span class="o">=</span> <span class="n">readData</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>In order to train dedupe, we need to compare some records. We can't compare them all, because the number of possible combinations can be much too large (~0.5*N^2). We take a random subset of our original data to pass to our training.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">data_d_sample</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">sampleDict</span><span class="p">(</span><span class="n">data_d</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>If the settings files, which we mentioned above, exists, then we read it in. Passing in a settings file is one of the three ways to initialize a dedupe instance.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_file</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;reading from &#39;</span><span class="p">,</span> <span class="n">settings_file</span>
    <span class="n">deduper</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">Dedupe</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Alternately, we can initialize a dedupe instance by declaring a field definition for the data. This defines the fields that we want to compare and how to compare them.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>A field definition is a dictionary where the keys are the fields that will be used for training a model and the values are the field specification.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Field types include
- String</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>A 'String' type field must have as its key a name of a field as it appears in the data dictionary and a type declaration ex. {'Phone': {type: 'String'}}</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">else</span><span class="p">:</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Site name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
            <span class="s">&#39;Address&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
            <span class="s">&#39;Zip&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
            <span class="s">&#39;Phone&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
            <span class="p">}</span>
  <span class="n">deduper</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">Dedupe</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Dedupe will learn to predict if two records are duplicates based upon their similarity. In this example, that similarity is a weighted combination of the field by field <a href="http://en.wikipedia.org/wiki/String_metric">string similarity</a> between records. Dedupe learns these weights.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Dedupe will ask a user to label pairs of records as duplicates or not. These labeled records are saved and can be reused for later training. To train dedupe with these examples, call deduper.train as shown.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">training_file</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;reading labeled examples from &#39;</span><span class="p">,</span> <span class="n">training_file</span>
    <span class="n">deduper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_d_sample</span><span class="p">,</span> <span class="n">training_file</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;starting active labeling...&#39;</span>
    <span class="k">print</span> <span class="s">&#39;finding uncertain pairs...&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Dedupe can actively learn, that means it will select the records it is most uncertain about and will ask the user to label it. It will then learn from that labeling, update, and ask for the next most uncertain pair.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>To do this, train method requires that you pass it a function to do this labeling, in this case, consoleLabel.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>For consoleLabel, use 'y', 'n' and 'u' keys to flag duplicates, 'f' when you are finished.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">else</span><span class="p">:</span>
      <span class="n">deduper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_d_sample</span><span class="p">,</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">training_sample</span><span class="o">.</span><span class="n">consoleLabel</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Save away our labeled training pairs to a JSON file.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">deduper</span><span class="o">.</span><span class="n">writeTraining</span><span class="p">(</span><span class="n">training_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Now that dedupe knows how to compare records, we use the same training data to block records in to groups. The goal is to reduce the total number of comparisons.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>blockingFunction learns the blocking rules, if not already defined in settings_file and returns a function. That function will take a record and return all the blocks it will fit in to.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;blocking...&#39;</span>
<span class="n">blocker</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">blockingFunction</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Save our settings file, which includes learned weights and blcoking rules.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">deduper</span><span class="o">.</span><span class="n">writeSettings</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>blockingIndex loads all the original data in to memory and places them in to blocks. Each record can be blocked in many ways, so for larger data, memory will be a limiting factor.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">blocked_data</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">blocking</span><span class="o">.</span><span class="n">blockingIndex</span><span class="p">(</span><span class="n">data_d</span><span class="p">,</span> <span class="n">blocker</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>duplicateClusters will return sets of record IDs that dedupe believes are all referrin to the same entity.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>pairwise_threshold -- Number between 0 and 1 (default is .5). We will only 
                      consider as duplicates  ecord pairs as duplicates if 
                      their estimated duplicate likelihood is greater than 
                      the pairwise threshold. 
cluster_threshold --  Number between 0 and 1 (default is .5). Lowering the 
                      number will increase precision, raising it will increase
                      recall</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;clustering...&#39;</span>
<span class="n">clustered_dupes</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">duplicateClusters</span><span class="p">(</span><span class="n">blocked_data</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Now that we have our clustered duplicates, we write our original data back out to a CSV with a new column called 'Cluster ID' which indicates which records refer to each other.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;# duplicate sets&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clustered_dupes</span><span class="p">)</span>
<span class="n">orig_data</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">cluster_membership</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cluster_id</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clustered_dupes</span><span class="p">)</span> <span class="p">:</span>
  <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">cluster</span> <span class="p">:</span>
    <span class="n">cluster_membership</span><span class="p">[</span><span class="n">record_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_id</span>

<span class="n">f_input</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span> 
<span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f_input</span><span class="p">)</span>
<span class="n">reader</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
  <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="n">heading_row</span> <span class="o">=</span> <span class="n">header</span>
  <span class="n">heading_row</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Cluster ID&quot;</span><span class="p">)</span>
  <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">heading_row</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">cluster_id</span> <span class="o">=</span> <span class="n">cluster_membership</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">row</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cluster_id</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="n">f_input</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
