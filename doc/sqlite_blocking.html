<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>sqlite_blocking.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>sqlite_blocking.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>This is an example of working with very large data. There are about
700,000 unduplicated donors in this database of Illinois political
campaign contributions.</p>
<p>While we might be able to keep these donor records in memory, we
cannot possibly store all the comparison pairs we will make.</p>
<p>Because of performance issues that we are still working through, this
example is broken into two files, sqlite_blocking.py which blocks the
data, sqlite_clustering.py which clusters the blocked data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">dedupe</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&#39;./examples/sqlite_example/&#39;</span><span class="p">)</span>
<span class="n">settings_file</span> <span class="o">=</span> <span class="s">&#39;sqlite_example_settings.json&#39;</span>
<span class="n">training_file</span> <span class="o">=</span> <span class="s">&#39;sqlite_example_training.json&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>When we compare records, we don't care about differences in case.
Lowering the case in SQL is much faster than in Python.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">donor_select</span> <span class="o">=</span> <span class="s">&quot;SELECT donor_id, LOWER(city) AS city, &quot;</span> \
               <span class="s">&quot;LOWER(first_name) AS first_name, &quot;</span> \
               <span class="s">&quot;LOWER(last_name) AS last_name, &quot;</span> \
               <span class="s">&quot;LOWER(zip) AS zip, LOWER(state) AS state, &quot;</span> \
               <span class="s">&quot;LOWER(address_1) AS address_1, &quot;</span> \
               <span class="s">&quot;LOWER(address_2) AS address_2 FROM donors&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Returns a random sample of pairs of donors of a given size</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getSample</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="n">dim</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT MAX(donor_id) FROM donors&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

  <span class="n">random_pairs</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">randomPairs</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">zero_indexed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

  <span class="n">all_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">random_pairs</span> <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>

  <span class="n">temp_d</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">donor_select</span> <span class="o">+</span> <span class="s">&quot; WHERE donor_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="s">&#39;?&#39;</span><span class="o">*</span><span class="n">size</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">all_ids</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">temp_d</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;donor_id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span>

  <span class="k">return</span> <span class="nb">tuple</span><span class="p">((((</span><span class="n">record_id_1</span><span class="p">,</span> <span class="n">temp_d</span><span class="p">[</span><span class="n">record_id_1</span><span class="p">]),</span>
                 <span class="p">(</span><span class="n">record_id_2</span><span class="p">,</span> <span class="n">temp_d</span><span class="p">[</span><span class="n">record_id_2</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">record_id_1</span><span class="p">,</span> <span class="n">record_id_2</span>
                <span class="ow">in</span> <span class="n">random_pairs</span><span class="p">))</span>



<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>For performance reasons, its faster to delete and recreate a large sqlite database file than to delete a large table.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
  <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;blocking_map.db&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
  <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Create our blocking map table in a separate database.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;creating blocking_map database&#39;</span>
<span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;blocking_map.db&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">con_blocking</span> <span class="p">:</span>
  <span class="n">con_blocking</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE blocking_map &quot;</span>
                       <span class="s">&quot;(key TEXT, donor_id INT)&quot;</span><span class="p">)</span>
  <span class="n">con_blocking</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;illinois_contributions.db&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>This is a nice way to get records we can index by the name of the
field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">con</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Attach blocking_map to our primary database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;ATTACH DATABASE &#39;blocking_map.db&#39; AS bm&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>To help with such large scale data, we are increasing the sqlite
cache size.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA cache_size = 2000&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Unlike csv_example.py, we select from the database to get a random
sample for training. As the dataset grows, duplicate pairs become
more rare. We need positive examples to train dedupe, so we have to
signficantly increase the size of the sample</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;selecting random sample from donors table...&#39;</span>
<span class="n">data_sample</span> <span class="o">=</span> <span class="n">getSample</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="mi">750000</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_file</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;reading from &#39;</span><span class="p">,</span> <span class="n">settings_file</span>
    <span class="n">deduper</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">Dedupe</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;first_name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;last_name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;address_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;address_2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;city&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;zip&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="p">}</span>
    <span class="n">deduper</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">Dedupe</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Sometimes we will want to add additional labeled examples to a
training file. To do this can just load the existing labeled
pairs...</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">training_file</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;reading labeled examples from &#39;</span><span class="p">,</span> <span class="n">training_file</span>
        <span class="n">deduper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_samples</span><span class="p">,</span> <span class="n">training_file</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;starting active labeling...&#39;</span>
    <span class="k">print</span> <span class="s">&#39;finding uncertain pairs...&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>... and then call training with our interactive function</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">deduper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_samples</span><span class="p">,</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">training_sample</span><span class="o">.</span><span class="n">consoleLabel</span><span class="p">)</span>
    <span class="n">deduper</span><span class="o">.</span><span class="n">writeTraining</span><span class="p">(</span><span class="n">training_file</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;blocking...&#39;</span>
<span class="n">t_block</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">blocker</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">blockingFunction</span><span class="p">(</span><span class="n">eta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">deduper</span><span class="o">.</span><span class="n">writeSettings</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;blocked in&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_block</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>So the learning is done and we have our blocker. However we cannot
block the data in memory. We have to pass through all the data and
create a blocking map table.</p>
<p>First though, if we learned a tf-idf predicate, we have to create an
tfIDF blocks for the full data set.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;creating inverted index&#39;</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;donor_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">donor_select</span><span class="p">))</span>
<span class="n">blocker</span><span class="o">.</span><span class="n">tfIdfBlocks</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Finally, we are ready to block the data. We'll do this by creating
a generator that yields a (block_key, donor_id) tuples. We guarantee
that these tuples will be unique</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;writing blocking map&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">block_data</span><span class="p">()</span> <span class="p">:</span>
    <span class="n">full_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;donor_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">donor_select</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">donor_id</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocker</span><span class="p">((</span><span class="n">donor_id</span><span class="p">,</span> <span class="n">record</span><span class="p">))</span> <span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">donor_id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>This takes the generator and writes into into our table</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">con</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s">&quot;INSERT INTO bm.blocking_map VALUES (?, ?)&quot;</span><span class="p">,</span>
                <span class="n">block_data</span><span class="p">())</span>
<span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Finally, we create an index on the blocking_key so that the group by
queries we will be making in sqlite_clustering can happen in a
reasonable time</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;blocking_map.db&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">con_blocking</span> <span class="p">:</span>
  <span class="k">print</span> <span class="s">&#39;creating blocking_map index&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>
  <span class="n">con_blocking</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE INDEX blocking_map_key_idx ON blocking_map (key)&quot;</span><span class="p">)</span>
  <span class="n">con_blocking</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
  <span class="k">print</span> <span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>

<span class="k">print</span> <span class="s">&#39;ran in&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
