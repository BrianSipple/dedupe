<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>mysql_example.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>mysql_example.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>This is an example of working with very large data. There are about
700,000 unduplicated donors in this database of Illinois political
campaign contributions.</p>
<p>With such a large set of input data, we cannot store all the comparisons 
we need to make in memory. Instead, we will read the pairs on demand
from the MySQL database.</p>
<p>For smaller datasets (&lt;10,000), see our <a href="http://open-city.github.com/dedupe/doc/csv_example.html">csv_example</a></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">optparse</span>

<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">MySQLdb.cursors</span>

<span class="kn">import</span> <span class="nn">dedupe</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h2>Logging</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Dedupe uses Python logging to show or suppress verbose output. Added for convenience.
To enable verbose logging, run <code>python examples/mysql_example/mysql_example.py -v</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">optp</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">()</span>
<span class="n">optp</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;count&#39;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">&#39;Increase verbosity (specify multiple times for more)&#39;</span>
                <span class="p">)</span>
<span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">optp</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span> 
<span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h2>Setup</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Create a select function that pulls in our campaign donor info.
When we compare records, we don't care about differences in casing,
so we lower the case (doing this in SQL is much faster than in Python).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">DONOR_SELECT</span> <span class="o">=</span> <span class="s">&quot;SELECT donor_id, LOWER(city) AS city, &quot;</span> \
               <span class="s">&quot;LOWER(first_name) AS first_name, &quot;</span> \
               <span class="s">&quot;LOWER(last_name) AS last_name, &quot;</span> \
               <span class="s">&quot;LOWER(zip) AS zip, LOWER(state) AS state, &quot;</span> \
               <span class="s">&quot;LOWER(address_1) AS address_1, &quot;</span> \
               <span class="s">&quot;LOWER(address_2) AS address_2 FROM donors&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getSample</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">id_column</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Returns a random sample of a given size of records pairs from a given</span>
<span class="sd">  MySQL table.</span>
<span class="sd">  &#39;&#39;&#39;</span>

  <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT MAX(</span><span class="si">%s</span><span class="s">) FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="p">,</span> <span class="p">(</span><span class="n">id_column</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
  <span class="n">num_records</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>dedupe expects the id column to contain unique, sequential itegers starting at 0 or 1</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="n">random_pairs</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">randomPairs</span><span class="p">(</span><span class="n">num_records</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">zero_indexed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

  <span class="n">temp_d</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">DONOR_SELECT</span><span class="p">)</span> 
  <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="p">:</span>
    <span class="n">temp_d</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">id_column</span><span class="p">])]</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frozendict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">random_pair_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">record_id_1</span><span class="p">,</span> <span class="n">record_id_2</span> <span class="ow">in</span> <span class="n">random_pairs</span><span class="p">:</span>
      <span class="k">yield</span> <span class="p">((</span><span class="n">record_id_1</span><span class="p">,</span> <span class="n">temp_d</span><span class="p">[</span><span class="n">record_id_1</span><span class="p">]),</span>
             <span class="p">(</span><span class="n">record_id_2</span><span class="p">,</span> <span class="n">temp_d</span><span class="p">[</span><span class="n">record_id_2</span><span class="p">]))</span>
  
  <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">record_pairs</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">random_pair_generator</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Switch to our working directory and set up our settings and training file locations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&#39;./examples/mysql_example/&#39;</span><span class="p">)</span>
<span class="n">settings_file</span> <span class="o">=</span> <span class="s">&#39;mysql_example_settings.json&#39;</span>
<span class="n">training_file</span> <span class="o">=</span> <span class="s">&#39;mysql_example_training.json&#39;</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <h2>Create a database connection</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>You'll need to copy <code>examples/mysql_example/mysql.cnf_LOCAL</code> to
<code>examples/mysql_example/mysql.cnf</code> and fill in your mysql
database information in <code>examples/mysql_example/mysql.cnf</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">con</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="s">&#39;contributions&#39;</span><span class="p">,</span>
                      <span class="n">read_default_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/mysql.cnf&#39;</span><span class="p">,</span> 
                      <span class="n">cursorclass</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <h2>Training</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_file</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;reading from &#39;</span><span class="p">,</span> <span class="n">settings_file</span>
    <span class="n">deduper</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">Dedupe</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Select a large sample of duplicate pairs.
As the dataset grows, duplicate pairs become relatively more
rare so we have to take a fairly large sample compared to
<code>csv_example.py</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">print</span> <span class="s">&#39;selecting random sample from donors table...&#39;</span>
    <span class="n">data_sample</span> <span class="o">=</span> <span class="n">getSample</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">750000</span><span class="p">,</span> <span class="s">&#39;donor_id&#39;</span><span class="p">,</span> <span class="s">&#39;donors&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Define the fields dedupe will pay attention to</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;first_name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;last_name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;address_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;address_2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;city&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="s">&#39;zip&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;String&#39;</span><span class="p">},</span>
              <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Create a new deduper object and pass our data model to it.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">deduper</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">Dedupe</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>If we have training data saved from a previous run of dedupe,
look for it an load it in.
<strong>Note:</strong> if you want to train from scratch, delete the training_file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">training_file</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;reading labeled examples from &#39;</span><span class="p">,</span> <span class="n">training_file</span>
        <span class="n">deduper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_sample</span><span class="p">,</span> <span class="n">training_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <h2>Active learning</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">print</span> <span class="s">&#39;starting active labeling...&#39;</span>
    <span class="k">print</span> <span class="s">&#39;finding uncertain pairs...&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Starts the trainin loop. Dedupe will find the next pair of records
it is least certain about and ask you to label them as duplicates
or not.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>use 'y', 'n' and 'u' keys to flag duplicates
press 'f' when you are finished</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">deduper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_sample</span><span class="p">,</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">consoleLabel</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>When finished, save our training away to disk</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">deduper</span><span class="o">.</span><span class="n">writeTraining</span><span class="p">(</span><span class="n">training_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <h2>Blocking</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;blocking...&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Initialize our blocker, which determines our field weights and blocking 
predicates based on our training data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">blocker</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">blockingFunction</span><span class="p">(</span><span class="n">eta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Save our weights and predicates to disk.
If the settings file exists, we will skip all the training and learning</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">deduper</span><span class="o">.</span><span class="n">writeSettings</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Iterate through all our input data and create a blocking map.
To run blocking on such a large set of data, we create a separate table
that contains blocking keys and record ids</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;creating blocking_map database&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS blocking_map&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE blocking_map &quot;</span>
          <span class="s">&quot;(block_key VARCHAR(200), donor_id INTEGER)&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>We are using <a href="http://en.wikipedia.org/wiki/Tf%E2%80%93idf">TF/IDF</a> as a 
potential predicate. 
If dedupe learned a TF-IDF blocking rule, we create go through the extra
step of creating TF-IDF canopies.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;creating inverted index&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">DONOR_SELECT</span> <span class="o">+</span> <span class="s">&quot; LIMIT 10000&quot;</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;donor_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
<span class="n">blocker</span><span class="o">.</span><span class="n">tfIdfBlocks</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Next, we write our blocking map table by creating a generator that 
yields unique <code>(block_key, donor_id)</code> tuples.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;writing blocking map&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">block_data</span><span class="p">()</span> <span class="p">:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">DONOR_SELECT</span> <span class="o">+</span> <span class="s">&quot; LIMIT 10000&quot;</span><span class="p">)</span>
    <span class="n">full_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;donor_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">donor_id</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocker</span><span class="p">((</span><span class="n">donor_id</span><span class="p">,</span> <span class="n">record</span><span class="p">))</span> <span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">donor_id</span><span class="p">)</span>

<span class="n">b_data</span> <span class="o">=</span> <span class="n">block_data</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>MySQL has a hard limit on the size of a data object that can be passed to it. 
To get around this, we chunk the blocked data in to groups of 10,000 blocks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">step</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">done</span> <span class="p">:</span>
  <span class="n">chunk</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">b_data</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>This takes the generator and writes into into our table</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="n">records_written</span> <span class="o">=</span>  <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s">&quot;INSERT INTO blocking_map VALUES (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span>
                                   <span class="n">chunk</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">records_written</span> <span class="o">&lt;</span> <span class="n">step</span> <span class="p">:</span>
    <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Create an index on the blocking key for faster clustering</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;creating blocking map index. this will probably take a while ...&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE INDEX blocking_map_key_idx ON blocking_map (block_key)&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <h2>Clustering</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Grabs a block of records for comparison.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">block_select</span> <span class="o">=</span> <span class="p">(</span><span class="n">DONOR_SELECT</span> <span class="o">+</span> 
                <span class="s">&quot; INNER JOIN blocking_map USING (donor_id) &quot;</span> 
                <span class="s">&quot;WHERE block_key = </span><span class="si">%s</span><span class="s"> ORDER BY donor_id&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Generator function that yields records based on blocking map keys</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">candidates_gen</span><span class="p">(</span><span class="n">block_keys</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block_keys</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
          <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;blocks&quot;</span>
          <span class="k">print</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="s">&quot;seconds&quot;</span>

        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">block_select</span><span class="p">,</span> <span class="p">(</span><span class="n">block_key</span><span class="p">,))</span>
        <span class="k">yield</span> <span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;donor_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Grab all the block keys with more than one record.
These records will make up a block of records we will cluster.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">blocking_key_sql</span> <span class="o">=</span> <span class="s">&quot;SELECT block_key, COUNT(*) AS num_candidates &quot;</span> \
                   <span class="s">&quot;FROM blocking_map GROUP BY block_key HAVING num_candidates &gt; 1&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Using a random sample of blocks we find our clustering threshold that maximizes
the weighted average of our precision and recall</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">blocking_key_sql</span> <span class="o">+</span> <span class="s">&quot; ORDER BY RAND() LIMIT 1000&quot;</span><span class="p">)</span>
<span class="n">sampled_block_keys</span> <span class="o">=</span> <span class="n">block_keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;block_key&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">goodThreshold</span><span class="p">(</span><span class="n">candidates_gen</span><span class="p">(</span><span class="n">sampled_block_keys</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>With our found threshold, and candidates generator, perform the clustering operation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">blocking_key_sql</span><span class="p">)</span>
<span class="n">block_keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;block_key&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

<span class="k">print</span> <span class="s">&#39;clustering...&#39;</span>
<span class="n">clustered_dupes</span> <span class="o">=</span> <span class="n">deduper</span><span class="o">.</span><span class="n">duplicateClusters</span><span class="p">(</span><span class="n">candidates_gen</span><span class="p">(</span><span class="n">block_keys</span><span class="p">),</span>
                                            <span class="n">threshold</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <h2>Writing out results</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>We now have a sequence of tuples of donor ids that dedupe believes all 
refer to the same entity. We write this out onto an entity map table</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS entity_map&quot;</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;creating entity_map database&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE entity_map &quot;</span>
          <span class="s">&quot;(donor_id INTEGER, head_id INTEGER, PRIMARY KEY(donor_id))&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clustered_dupes</span> <span class="p">:</span>
    <span class="n">cluster_head</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;INSERT INTO entity_map VALUES (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">cluster_head</span><span class="p">,</span> <span class="n">cluster_head</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cluster</span> <span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;INSERT INTO entity_map VALUES (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">cluster_head</span><span class="p">))</span>

<span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE INDEX head_index ON entity_map (head_id)&quot;</span><span class="p">)</span>
<span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Print out the number of duplicates found</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&#39;# duplicate sets&#39;</span>
<span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">clustered_dupes</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Close our database connection</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">print</span> <span class="s">&#39;ran in&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
