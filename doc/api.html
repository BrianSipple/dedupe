<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>api.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>api.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>dedupe provides the main user interface for the library the
Dedupe class</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">json.scanner</span> <span class="kn">import</span> <span class="n">py_make_scanner</span>
    <span class="kn">import</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simplejson.scanner</span> <span class="kn">import</span> <span class="n">py_make_scanner</span>
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">dedupe</span>
<span class="kn">import</span> <span class="nn">dedupe.core</span> <span class="kn">as</span> <span class="nn">core</span>
<span class="kn">import</span> <span class="nn">dedupe.training</span> <span class="kn">as</span> <span class="nn">training</span>
<span class="kn">import</span> <span class="nn">dedupe.training_serializer</span> <span class="kn">as</span> <span class="nn">training_serializer</span>
<span class="kn">import</span> <span class="nn">dedupe.crossvalidation</span> <span class="kn">as</span> <span class="nn">crossvalidation</span>
<span class="kn">import</span> <span class="nn">dedupe.predicates</span> <span class="kn">as</span> <span class="nn">predicates</span>
<span class="kn">import</span> <span class="nn">dedupe.blocking</span> <span class="kn">as</span> <span class="nn">blocking</span>
<span class="kn">import</span> <span class="nn">dedupe.clustering</span> <span class="kn">as</span> <span class="nn">clustering</span>
<span class="kn">import</span> <span class="nn">dedupe.tfidf</span> <span class="kn">as</span> <span class="nn">tfidf</span>
<span class="kn">from</span> <span class="nn">dedupe.distance.affinegap</span> <span class="kn">import</span> <span class="n">normalizedAffineGapDistance</span>
<span class="kn">from</span> <span class="nn">dedupe.distance.haversine</span> <span class="kn">import</span> <span class="n">compareLatLong</span>
<span class="kn">from</span> <span class="nn">dedupe.distance.jaccard</span> <span class="kn">import</span> <span class="n">compareJaccard</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="p">:</span>
    <span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">OrderedDict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Public methods:
<strong>init</strong>
train
blockingFunction
goodThreshold
duplicateClusters
writeTraining
writeSettings</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Dedupe</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Load or initialize a data model.</p>
<h3>Example usage</h3>
<p>```python</p>
<h1>initialize from a settings file</h1>
<p>deduper = dedupe.Dedupe('my_learned_settings')
<code>or</code>python</p>
<h1>initialize from a defined set of fields</h1>
<p>fields = {
'Site name': {'type': 'String'},
'Address': {'type': 'String'},
'Zip': {'type': 'String', 'Has Missing':True},
'Phone': {'type': 'String', 'Has Missing':True},
}</p>
<p>deduper = dedupe.Dedupe(fields)
```</p>
<h3>Keyword arguments</h3>
<p><code>init</code>
A field definition or a file location for a settings file.</p>
<h3>Additional detail</h3>
<p>A field definition is a dictionary where the keys are the fields
that will be used for training a model and the values are the
field specification</p>
<p>Field types include
* String</p>
<p>A 'String' type field must have as its key a name of a field
as it appears in the data dictionary and a type declaration
ex. <code>{'Phone': {type: 'String'}}</code></p>
<p>Longer example of a field definition:</p>
<p><code>python
fields = {'name':       {'type': 'String'},
          'address':    {'type': 'String'},
          'city':       {'type': 'String'},
          'cuisine':    {'type': 'String'}
          }</code></p>
<p>Settings files are typically generated by saving the settings
learned in a previous session. If you need details for this
file see the method writeSettings.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">init</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="n">init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span> <span class="o">=</span> <span class="n">_initializeDataModel</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">init</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">init</span><span class="p">:</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readSettings</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">init</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Incorrect Input Type: must supply either a &#39;</span>
                             <span class="s">&#39;field definition or a settings file.&#39;</span>
                             <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No Input: must supply either a field &#39;</span>
                             <span class="s">&#39;definition or a settings file.&#39;</span>
                             <span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sample</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dupes</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_encoder</span> <span class="o">=</span> <span class="n">training_serializer</span><span class="o">.</span><span class="n">_to_json</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_decoder</span> <span class="o">=</span> <span class="n">training_serializer</span><span class="o">.</span><span class="n">dedupe_decoder</span>

        <span class="n">string_predicates</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicates</span><span class="o">.</span><span class="n">wholeFieldPredicate</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">tokenFieldPredicate</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">commonIntegerPredicate</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">sameThreeCharStartPredicate</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">sameFiveCharStartPredicate</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">sameSevenCharStartPredicate</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">nearIntegersPredicate</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">commonFourGram</span><span class="p">,</span>
                             <span class="n">predicates</span><span class="o">.</span><span class="n">commonSixGram</span><span class="p">)</span>

        <span class="n">tfidf_string_predicates</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">tfidf</span><span class="o">.</span><span class="n">TfidfPredicate</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">threshold</span>
                                         <span class="ow">in</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blocker_types</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;String&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">string_predicates</span>
                                          <span class="o">+</span> <span class="n">tfidf_string_predicates</span><span class="p">)}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Loads labeled examples from file, if passed.</p>
<p>Keyword arguments:
training_file -- path to a json file of labeled examples</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_initializeTraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">training_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">n_fields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">])</span>

        <span class="n">training_dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;label&#39;</span><span class="p">,</span> <span class="s">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;distances&#39;</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">n_fields</span><span class="p">,</span> <span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">training_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">training_file</span><span class="p">:</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readTraining</span><span class="p">(</span><span class="n">training_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <h3><span id="dedupe.train" href="dedupe.train"> Dedupe.train </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">data_sample</span><span class="p">,</span>
              <span class="n">training_source</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Learn field weights from file of labeled examples or round of 
interactive labeling</p>
<p>Keyword arguments:
data_sample -- a sample of record pairs
training_source -- either a path to a file of labeled examples or
                   a labeling function</p>
<p>In the sample of record_pairs, each element is a tuple of two
records. Each record is, in turn, a tuple of the record's key and
a record dictionary.</p>
<p>In in the record dictionary the keys are the names of the
record field and values are the record values.</p>
<p>For example, a data_sample with only one pair of records,</p>
<p>[
  (
   (854, {'city': 'san francisco',
          'address': '300 de haro st.',
          'name': "sally's cafe &amp; bakery",
          'cuisine': 'american'}),
   (855, {'city': 'san francisco',
         'address': '1328 18th st.',
         'name': 'san francisco bbq',
         'cuisine': 'thai'})
   )
 ]</p>
<p>The labeling function will be used to do active learning. The
function will be supplied a list of examples that the learner
is the most 'curious' about, that is examples where we are most
uncertain about how they should be labeled. The labeling function
will label these, and based upon what we learn from these
examples, the labeling function will be supplied with new
examples that the learner is now most curious about.  This will
continue until the labeling function sends a message that we
it is done labeling.</p>
<p>The labeling function must be a function that takes two
arguments.  The first argument is a sequence of pairs of
records. The second argument is the data model.</p>
<p>The labeling function must return two outputs. The function
must return a dictionary of labeled pairs and a finished flag.</p>
<p>The dictionary of labeled pairs must have two keys, 1 and 0,
corresponding to record pairs that are duplicates or
nonduplicates respectively. The values of the dictionary must
be a sequence of records pairs, like the sequence that was
passed in.</p>
<p>The 'finished' flag should take the value False for active
learning to continue, and the value True to stop active learning.</p>
<p>i.e.</p>
<p>labelFunction(record_pairs, data_model) :
    ...
    return (labeled_pairs, finished)</p>
<p>For a working example, see consoleLabel in training</p>
<p>Labeled example files are typically generated by saving the
examples labeled in a previous session. If you need details
for this file see the method writeTraining.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">data_sample</span> <span class="o">=</span> <span class="n">data_sample</span>

        <span class="k">if</span> <span class="n">training_source</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">training_source</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="k">if</span> <span class="n">training_source</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;reading training from file&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initializeTraining</span><span class="p">(</span><span class="n">training_source</span><span class="p">)</span>

            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readTraining</span><span class="p">(</span><span class="n">training_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">training_source</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initializeTraining</span><span class="p">()</span>

            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">,</span> 
             <span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">)</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">activeLearning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sample</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span>
                                                        <span class="n">training_source</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span><span class="p">)</span>



        <span class="n">alpha</span> <span class="o">=</span> <span class="n">crossvalidation</span><span class="o">.</span><span class="n">gridSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">,</span>
                                           <span class="n">core</span><span class="o">.</span><span class="n">trainModel</span><span class="p">,</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span> 
                                           <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">trainModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span> 
                                          <span class="n">alpha</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logLearnedWeights</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Returns a function that takes in a record dictionary and
returns a list of blocking keys for the record. We will
learn the best blocking predicates if we don't have them already.</p>
<p>Keyword arguments:
ppc -- Limits the Proportion of Pairs Covered that we allow a
       predicate to cover. If a predicate puts together a fraction
       of possible pairs greater than the ppc, that predicate will
       be removed from consideration.</p>
<pre><code>   As the size of the data increases, the user will generally
   want to reduce ppc.

   ppc should be a value between 0.0 and 1.0
</code></pre>
<p>uncovered_dupes -- The number of true dupes pairs in our training
                   data that we can accept will not be put into any
                   block. If true true duplicates are never in the
                   same block, we will never compare them, and may
                   never declare them to be duplicates.</p>
<pre><code>               However, requiring that we cover every single
               true dupe pair may mean that we have to use
               blocks that put together many, many distinct pairs
               that we'll have to expensively, compare as well.
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">blockingFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">uncovered_dupes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learnBlocking</span><span class="p">(</span><span class="n">ppc</span><span class="p">,</span> <span class="n">uncovered_dupes</span><span class="p">)</span>

        <span class="n">blocker</span> <span class="o">=</span> <span class="n">blocking</span><span class="o">.</span><span class="n">Blocker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">blocker</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Returns the threshold that maximizes the expected F score,
a weighted average of precision and recall for a sample of
blocked data. </p>
<p>Keyword arguments:
blocks --        Sequence of tuples of records, where each
                 tuple is a set of records covered by a blocking
                 predicate</p>
<p>recall_weight -- Sets the tradeoff between precision and
                 recall. I.e. if you care twice as much about
                 recall as you do precision, set recall_weight
                 to 2.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">goodThreshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">recall_weight</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">field_distances</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fieldDistances</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">)</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">scorePairs</span><span class="p">(</span><span class="n">field_distances</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">)</span>

        <span class="n">probability</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="n">probability</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">expected_dupes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">probability</span><span class="p">)</span>

        <span class="n">recall</span> <span class="o">=</span> <span class="n">expected_dupes</span> <span class="o">/</span> <span class="n">expected_dupes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="n">expected_dupes</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_dupes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">score</span> <span class="o">=</span> <span class="n">recall</span> <span class="o">*</span> <span class="n">precision</span> <span class="o">/</span> <span class="p">(</span><span class="n">recall</span> <span class="o">+</span> <span class="n">recall_weight</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">precision</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Maximum expected recall and precision&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;recall: </span><span class="si">%2.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">recall</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;precision: </span><span class="si">%2.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;With threshold: </span><span class="si">%2.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">probability</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">probability</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Partitions blocked data and returns a list of clusters, where
each cluster is a tuple of record ids</p>
<p>Keyword arguments:
blocks --     Sequence of tuples of records, where each
              tuple is a set of records covered by a blocking
              predicate</p>
<p>threshold --  Number between 0 and 1 (default is .5). We will
              only consider as duplicates record pairs as
              duplicates if their estimated duplicate likelihood is
              greater than the threshold.</p>
<pre><code>          Lowering the number will increase recall, raising it
          will increase precision
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">duplicateClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=.</span><span class="mi">5</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Setting the cluster threshold this ways is not principled,
but seems to reliably help performance</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">cluster_threshold</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">*</span> <span class="mf">0.7</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dupes</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">scoreDuplicates</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dupes</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">clusters</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Learn a good blocking of the data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_learnBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">confident_nonduplicates</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">semiSupervisedNonDuplicates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sample</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span>
                                                                       <span class="n">sample_size</span><span class="o">=</span><span class="mi">32000</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">confident_nonduplicates</span><span class="p">)</span>


        <span class="n">predicate_set</span> <span class="o">=</span> <span class="n">predicateGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocker_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">)</span>


        
        <span class="n">learned_predicates</span> <span class="o">=</span> <span class="n">dedupe</span><span class="o">.</span><span class="n">blocking</span><span class="o">.</span><span class="n">blockTraining</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span><span class="p">,</span>
                                                           <span class="n">predicate_set</span><span class="p">,</span>
                                                           <span class="n">eta</span><span class="p">,</span>
                                                           <span class="n">epsilon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">learned_predicates</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Log learned weights and bias terms</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_logLearnedWeights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Learned Weights&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">k2</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="n">k2</span><span class="p">,</span> <span class="n">v2</span><span class="p">[</span><span class="s">&#39;weight&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="n">k1</span><span class="p">,</span> <span class="n">v1</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Write a settings file that contains the 
data model and predicates</p>
<p>Keyword arguments:
file_name -- path to file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">writeSettings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_readSettings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">predicates</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The settings file doesn&#39;t seem to be in &quot;</span>
                                 <span class="s">&quot;right format. You may want to delete the &quot;</span>
                                 <span class="s">&quot;settings file and try again&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data_model</span><span class="p">,</span> <span class="n">predicates</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Write to a json file that contains labeled examples</p>
<p>Keyword arguments:
file_name -- path to a json file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">writeTraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">d_training_pairs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_pairs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">d_training_pairs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d_training_pairs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_encoder</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Read training pairs from a file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_readTraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">training_pairs</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">training_pairs_raw</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_decoder</span><span class="p">)</span>

        <span class="n">training_pairs</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[],</span> <span class="mi">1</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">examples</span><span class="p">)</span> <span class="ow">in</span> <span class="n">training_pairs_raw</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
                <span class="n">training_pairs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">core</span><span class="o">.</span><span class="n">frozendict</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                   <span class="n">core</span><span class="o">.</span><span class="n">frozendict</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

        <span class="n">training_data</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">addTrainingData</span><span class="p">(</span><span class="n">training_pairs</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">data_model</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">training_pairs</span><span class="p">,</span> <span class="n">training_data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Initialize a data_model with a field definition</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_initializeDataModel</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">data_model</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Incorrect field specification: field &quot;</span>
                             <span class="s">&quot;specifications are dictionaries that must &quot;</span>
                             <span class="s">&quot;include a type definition, ex. &quot;</span>
                             <span class="s">&quot;{&#39;Phone&#39;: {type: &#39;String&#39;}}&quot;</span>
                             <span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Missing field type: field &quot;</span>
                             <span class="s">&quot;specifications are dictionaries that must &quot;</span>
                             <span class="s">&quot;include a type definition, ex. &quot;</span>
                             <span class="s">&quot;{&#39;Phone&#39;: {type: &#39;String&#39;}}&quot;</span>
                             <span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;String&#39;</span><span class="p">,</span>
                               <span class="s">&#39;LatLong&#39;</span><span class="p">,</span>
                               <span class="s">&#39;Set&#39;</span><span class="p">,</span>
                               <span class="s">&#39;Custom&#39;</span><span class="p">,</span>
                               <span class="s">&#39;Interaction&#39;</span><span class="p">]:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid field type: field &quot;</span>
                             <span class="s">&quot;specifications are dictionaries that must &quot;</span>
                             <span class="s">&quot;include a type definition, ex. &quot;</span>
                             <span class="s">&quot;{&#39;Phone&#39;: {type: &#39;String&#39;}}&quot;</span>
                             <span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;LatLong&#39;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;comparator&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Custom comparators can only be defined &quot;</span>
                                  <span class="s">&quot;for fields of type &#39;Custom&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="s">&#39;comparator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compareLatLong</span>

        <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Set&#39;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;comparator&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Custom comparators can only be defined &quot;</span>
                                  <span class="s">&quot;for fields of type &#39;Custom&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="s">&#39;comparator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compareJaccard</span>


        <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;String&#39;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;comparator&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Custom comparators can only be defined &quot;</span>
                                 <span class="s">&quot;for fields of type &#39;Custom&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="s">&#39;comparator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalizedAffineGapDistance</span>

        <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Custom&#39;</span> <span class="ow">and</span> <span class="s">&#39;comparator&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;For &#39;Custom&#39; field types you must define &quot;</span>
                             <span class="s">&quot;a &#39;comparator&#39; fucntion in the field &quot;</span>
                             <span class="s">&quot;definition. &quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Interaction&#39;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;Interaction Fields&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
                 <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;Interaction Fields&#39;</span><span class="p">]</span> <span class="p">:</span>
                     <span class="k">if</span> <span class="s">&#39;Has Missing&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="p">:</span>
                         <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;Has Missing&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
                         <span class="k">break</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No &quot;Interaction Fields&quot; defined&#39;</span><span class="p">)</span>

            <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;weight&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">interaction_terms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>We want the interaction terms to be at the end of of the
ordered dict so we'll add them after we finish
processing all the other fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">continue</span>
            
        

        <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>


    <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">interaction_terms</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;Has Missing&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
             <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;Has Missing&#39;</span><span class="p">]</span> <span class="p">:</span>
                 <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">][</span><span class="n">k</span> <span class="o">+</span> <span class="s">&#39;: not_missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;weight&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                              <span class="s">&#39;type&#39;</span>   <span class="p">:</span> <span class="s">&#39;Missing Data&#39;</span><span class="p">}</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;Has Missing&#39;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
         


    <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">data_model</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">predicateGenerator</span><span class="p">(</span><span class="n">blocker_types</span><span class="p">,</span> <span class="n">data_model</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">predicate_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">record_type</span><span class="p">,</span> <span class="n">predicate_functions</span> <span class="ow">in</span> <span class="n">blocker_types</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_name</span> <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">details</span>
                  <span class="ow">in</span> <span class="n">data_model</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">record_type</span><span class="p">]</span>
        <span class="n">predicate_set</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">predicate_functions</span><span class="p">,</span> <span class="n">fields</span><span class="p">)))</span>
    <span class="n">predicate_set</span> <span class="o">=</span> <span class="n">disjunctivePredicates</span><span class="p">(</span><span class="n">predicate_set</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predicate_set</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">disjunctivePredicates</span><span class="p">(</span><span class="n">predicate_set</span><span class="p">):</span>

    <span class="n">disjunctive_predicates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">predicate_set</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>filter out disjunctive predicates that operate on same field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">disjunctive_predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">predicate</span> <span class="k">for</span> <span class="n">predicate</span> <span class="ow">in</span> <span class="n">disjunctive_predicates</span> 
                              <span class="k">if</span> <span class="n">predicate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">predicate</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">predicate_set</span> <span class="o">=</span> <span class="p">[(</span><span class="n">predicate</span><span class="p">,</span> <span class="p">)</span> <span class="k">for</span> <span class="n">predicate</span> <span class="ow">in</span> <span class="n">predicate_set</span><span class="p">]</span>
    <span class="n">predicate_set</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">disjunctive_predicates</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predicate_set</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
